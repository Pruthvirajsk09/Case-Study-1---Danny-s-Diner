-- 1.What is the total amount each customer spent at the restaurant?

select customer_id,sum(price) total_spent from sales s
join menu m on s.product_id=m.product_id
group by customer_id;


-- 2.How many days has each customer visited the restaurant?

select customer_id, count(distinct(order_date)) days_visited from sales
group by customer_id;



-- 3.What was the first item from the menu purchased by each customer?

with cte1 as(select customer_id, order_date, s.product_id, product_name,
row_number() over(partition by customer_id) as _rank
from sales s
join menu m on m.product_id=s.product_id)

select customer_id,product_name first_ordered_item from cte1
where _rank=1;


-- 4.What is the most purchased item on the menu and how many times was it purchased by all customers?

select product_name,count(customer_id) times_ordered
from sales s
join menu m on m.product_id=s.product_id
group by product_name
order by times_ordered desc 
limit 1;


-- 5.Which item was the most popular for each customer?


with cte1 as(select customer_id,product_name,count(customer_id) times_ordered,
dense_rank() over(partition by customer_id order by count(customer_id) desc) as rank_
from sales s
join menu m on m.product_id=s.product_id
group by customer_id,product_name
order by customer_id asc)

select customer_id,product_name,times_ordered
from cte1 where rank_=1;


-- 6.Which item was purchased first by the customer after they became a member?

with cte1 as(select s.customer_id, s.order_date, s.product_id, join_date, product_name,
row_number() over(partition by customer_id) as rank_
from
sales s join members m on s.customer_id=m.customer_id
join menu me on me.product_id=s.product_id
where order_date>join_date)

select customer_id,product_name as after_member_first_item_ordered
from cte1 where rank_=1;


-- 7.Which item was purchased just before the customer became a member?

with cte1 as(select s.customer_id, s.order_date, s.product_id, join_date, product_name,
dense_rank() over(partition by customer_id order by order_date desc) as rank_
from
sales s join members m on s.customer_id=m.customer_id
join menu me on me.product_id=s.product_id
where order_date<join_date)

select customer_id,product_name as after_member_first_item_ordered
from cte1 where rank_=1;


-- 8.What is the total items and amount spent for each member before they became a member?

with cte1 as(select s.customer_id, s.product_id, price
from
sales s join members m on s.customer_id=m.customer_id
join menu me on me.product_id=s.product_id
where order_date<join_date)

select customer_id,count(product_id) as orders,sum(price) as spent
from cte1 group by customer_id;


-- 9.If each $1 spent equates to 10 points and sushi has a 2x points multiplier how many points would each customer have?

with cte1 as(select s.customer_id, s.product_id,product_name, price,
case when product_name="sushi" then price*10*2 else price*10 end as points
from
sales s join members m on s.customer_id=m.customer_id
join menu me on me.product_id=s.product_id)

select customer_id, sum(points) total_points from cte1
group by customer_id;
